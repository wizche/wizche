---
layout: post
title: Windows 7 L2TP over IPSec RASClient - IPSec proposal unacceptable
date: '2010-02-15T11:16:00.000-08:00'
author: Wizche
tags:
- asa vpn security windows7 l2tp ipsec ike
modified_time: '2010-02-17T05:51:28.682-08:00'
thumbnail: http://4.bp.blogspot.com/_cXYmdFluLpw/S3rOrrblK6I/AAAAAAAAAfk/soiW9joxqvI/s72-c/Transformset+solution+Win7+RASclient.jpg
blogger_id: tag:blogger.com,1999:blog-6991263519641111952.post-3697245277061765952
blogger_orig_url: http://blog.wizche.ch/2010/02/windows-7-l2tp-over-ipsec-rasclient.html
---

Apparently there is no painless upgrade....<br /><br />Here is what, normal situation, VPN users connect to an ASA endpoint to access internal resources via <a href="http://en.wikipedia.org/wiki/Layer_2_Tunneling_Protocol#L2TP.2FIPsec">L2TP/IPSec</a> client (RASclient) embedded on their Windows XP machines.<br /><br />Now the users upgrade their machines to Windows 7 (64 bits) and guess what? The VPN tunnel didnt come up anymore (Error 789).<br /><br />Debugging on the ASA device show up that the error came up during the <a href="http://www.ciscopress.com/articles/article.asp?p=25474&amp;seqNum=7">IKE Phase 2</a> part, and the reason was:<br /><i style="color: red;">All IPSec SA proposals</i><span style="color: red;"> found unacceptable!</span><br /><br />My firsts though (after some advises from a security specialist) was to look at the encryption and hashing algorithm used for this tunnel.<br /><br />My configuration was the following:<br />Encryption algorithm: 3DES<br />Integrity algorithm: MD5<br /><a href="http://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">DH-Group</a>: 2<br />(Encryption give you the confidentiality and hashing functions the integrity of the message, Diffie-Hellman is used to generate a secure channel where exchange further connection details during phase 2)<br /><br />Both endpoint must support the same encryption/hashing/DH-Group to sucessfully generate an IPSec tunnel...<br /><br /><a href="http://4.bp.blogspot.com/_cXYmdFluLpw/S3rOrrblK6I/AAAAAAAAAfk/soiW9joxqvI/s1600-h/Transformset+solution+Win7+RASclient.jpg" onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5438886749791398818" src="http://4.bp.blogspot.com/_cXYmdFluLpw/S3rOrrblK6I/AAAAAAAAAfk/soiW9joxqvI/s320/Transformset+solution+Win7+RASclient.jpg" style="cursor: pointer; float: left; height: 254px; margin: 0pt 10px 10px 0pt; width: 320px;" /></a>I wondered a little about this data and <a href="http://en.wikipedia.org/wiki/MD5">MD5</a>, sounds me obsolete, maybe they removed it  from the RASclient of new Windows releases?<br />Let's try, I create a new transform-set, with the same parameters (3DES and DH-Group 2) changing just <a href="http://en.wikipedia.org/wiki/MD5">MD5 </a>into <a href="http://en.wikipedia.org/wiki/SHA_hash_functions">SHA-1</a>, added to the crypto-map and guess what... it <span style="color: #33cc00; font-weight: bold;">WORKED</span>!<br /><br />My conclusion is that, cause of the weaknesses of MD5, Microsoft removed it from the newer L2TP/IPSec Client (RASclient).<br /><br />Hope this may help someone who had found this error too.